<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream Player</title>
    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
        }
        .video-js,
        #live-player {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            min-width: 100vw;
            min-height: 100vh;
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            background: #000;
            border-radius: 0;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body style="margin:0;background:#000;">
    <video
        id="live-player"
        class="video-js vjs-default-skin"
        controls
        autoplay
        playsinline
        style="width:100vw;height:100vh;object-fit:contain;position:fixed;top:0;left:0;"
    >
        <p class="vjs-no-js">
            To view this video please enable JavaScript, or consider upgrading to a web browser that
            <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
        </p>
    </video>

    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const streamKey = urlParams.get('stream') || 'my-live-stream';
            
            // Make sure this path matches your server configuration
            const hlsUrl = window.location.protocol + '//' + window.location.host + `/hls/${streamKey}.m3u8`;
            
            console.log('Attempting to load HLS stream from:', hlsUrl);

            // Check if HLS is supported
            const video = document.getElementById('live-player');
            
            // First try native HLS support
            if (video.canPlayType('application/vnd.apple.mpegurl')) {
                console.log('Using native HLS support');
                // Initialize video.js player
                const player = videojs('live-player', {
                    liveui: true,
                    responsive: true,
                    fluid: true,
                    liveTracker: {
                        trackingThreshold: 0.3,
                        liveTolerance: 0.5
                    },
                    sources: [{
                        src: hlsUrl,
                        type: 'application/vnd.apple.mpegurl'
                    }]
                });
                
                setupPlayerCallbacks(player);
            }
            // Otherwise use HLS.js
            else if (Hls.isSupported()) {
                console.log('Using HLS.js');
                const hls = new Hls({
                    debug: true,
                    lowLatencyMode: true,
                    backBufferLength: 0,
                    maxBufferLength: 2,
                    maxMaxBufferLength: 4
                });
                
                hls.loadSource(hlsUrl);
                
                // Handle HLS.js errors
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS.js error:', data.type, data.details, data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log('Network error, trying to recover...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('Media error, trying to recover...');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.log('Unrecoverable error, destroying HLS instance');
                                hls.destroy();
                                break;
                        }
                    }
                });
                
                // Bind HLS to the video element
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    console.log('HLS manifest parsed, starting playback');
                    video.play();
                });
                
                // Initialize Video.js after HLS.js setup
                const player = videojs('live-player', {
                    liveui: true,
                    techOrder: ["html5"],
                    html5: { hls: { overrideNative: true } }
                });
                
                setupPlayerCallbacks(player);
            } else {
                console.error('Neither native HLS nor HLS.js are supported in this browser');
                alert('Your browser does not support HLS playback');
            }
            
            // Helper function for player callbacks
            function setupPlayerCallbacks(player) {
                player.ready(function() {
                    console.log('Player is ready');
                    
                    // Start at live edge (not time 0)
                    player.on('loadedmetadata', function() {
                        if (player.liveTracker && player.liveTracker.seekableEnd) {
                            const livePoint = player.liveTracker.seekableEnd();
                            console.log('Setting to live point:', livePoint);
                            player.currentTime(livePoint);
                        }
                        player.play().catch(e => console.error('Play failed:', e));
                    });
                    
                    // Recovery for stalls
                    player.on('waiting', function() {
                        console.log('Player stalled, attempting recovery');
                        setTimeout(function() {
                            if (player.paused()) {
                                player.play().catch(e => console.error('Recovery play failed:', e));
                            }
                        }, 1000);
                    });
                    
                    player.on('error', function(e) {
                        console.error('Video.js error:', player.error());
                    });
                });
            }
        });
    </script>
</body>
</html>